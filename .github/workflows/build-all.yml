name: Build all aur package

on:
  schedule:
    - cron: "1 */8 * * *"

jobs:
  build:
    strategy:
      matrix:
        repos:
          - clash-verge-rev-bin
          - baidunetdisk-bin
          - dingtalk-bin
          - feishu-bin
          - hysteria-bin
          - intellij-idea-ultimate-edition
          - linuxqq-nt-bwrap
          - localsend-bin
          - mailspring-bin
          - netease-cloud-music-gtk4
          - wechat-universal-bwrap
          - wemeet-bin
      fail-fast: false

    runs-on: ubuntu-latest
    steps:
      - name: Build package ${{ matrix.repos }}
        uses: DuckSoft/build-aur-action@master
        with:
          repo-name: ${{ matrix.repos }}

      - name: Cache package
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.repos }}
          path: ./*.pkg.tar.zst

  generate-repo:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all built packages
        uses: actions/download-artifact@v3
        with:
          path: ./packages

      - name: Move packages into repo folder
        run: |
          mkdir repo
          find ./packages -name '*.pkg.tar.zst' -exec cp {} ./repo/ \;

      - name: Generate pacman repo database
        uses: ./generator_database
        with:
          repo-path: ./repo
        
      - name: Upload repo files
        uses: actions/upload-artifact@v3
        with:
          name: repo
          path: ./repo
