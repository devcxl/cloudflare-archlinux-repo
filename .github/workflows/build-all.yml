name: Build all aur package

on:
  schedule:
    - cron: "0 0 12 * *"
  workflow_dispatch:
jobs:
  build:
    strategy:
      matrix:
        repos:
          - hysteria-bin
          - localsend-bin
      fail-fast: false

    runs-on: ubuntu-latest
    steps:
      - name: Build package ${{ matrix.repos }}
        uses: DuckSoft/build-aur-action@master
        with:
          repo-name: ${{ matrix.repos }}

      - name: Cache package
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.repos }}
          path: .${{ matrix.repos }}/*.pkg.tar.zst

  generate-repo:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all built packages
        uses: actions/download-artifact@v3
        with:
          path: ./packages

      - name: Move packages into repo folder
        run: |
          mkdir repo
          find ./packages -name '*.pkg.tar.zst' -exec cp {} ./repo/ \;

      - name: Generate pacman repo database
        uses: ./generator_database
        with:
          repo-path: ./repo
        
      - name: Upload repo files
        uses: actions/upload-artifact@v3
        with:
          name: repo
          path: ./repo
